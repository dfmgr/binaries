#!/usr/bin/env bash

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
PROG="gen-script"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 022420211808-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.com
# @License       : WTFPL
# @ReadME        : gen-script --help
# @Copyright     : Copyright: (c) 2021 CasjaysDev
# @Created       : Sunday, Feb 07, 2021 13:25 EST
# @File          : gen-script
# @Description   : Create a script from template
# @TODO          :
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
user_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# I'm sure there is a better way to do this
if [ -d "$1" ]; then
  MYCURRDIR="$1"
  shift 1
elif [ "$1" = "-d" ] || [ "$1" = "-dir" ] || [ "$1" = "--dir" ]; then
  MYCURRDIR="$2"
  shift 2
  [ -d "$MYCURRDIR" ] || printf_exit "$MYCURRDIR doesn't seem to be a directory"
else
  MYCURRDIR="$PWD"
fi
if [ "$1" = "--skip" ]; then OVERWRITE="Y" && OPENEDIT="N" && shift 1; fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# default variables
topdir="$(__git_top_dir "$MYCURRDIR" || echo $MYCURRDIR 2>/dev/null)"
GEN_SCRIPTS_YEAR="$(date +%Y 2>/dev/null)"
GEN_SCRIPTS_EMAIL="${USER}"
GEN_SCRIPTS_AUTHOR="${USER}"
GEN_SCRIPTS_COMPANY="${USER}"
GEN_SCRIPTS_VERSION="%m%d%Y%H%M-git"
GEN_SCRIPTS_DEFREADME="README"
GEN_SCRIPTS_DEFLICENSE="WTFPL"
GEN_SCRIPTS_DATEFMT="%A, %b %d, %Y %H:%M %Z"
GEN_SCRIPTS_COPYRIGHT="Copyright: (c) $GEN_SCRIPTS_YEAR $GEN_SCRIPTS_AUTHOR, $GEN_SCRIPTS_COMPANY"
GEN_SCRIPTS_CURRENT_DIR="$MYCURRDIR"

if [ -d "$HOME/.config/gen-script/files" ]; then
  GEN_SCRIPTS_TEMPLATE_DIR="$HOME/.config/gen-script/files"
else
  GEN_SCRIPTS_TEMPLATE_DIR="${GEN_SCRIPTS_TEMPLATE_DIR:-$CASJAYSDEVDIR/templates/scripts}"
fi
[ -f "$HOME/.config/gen-script/settings" ] && . "$HOME/.config/gen-script/settings"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ "$(__count_files $HOME/.config/gen-script/files "3")" -eq 0 ]; then
  __mkd "$HOME/.config/gen-script/files"
  if [ "$(__count_files "$CASJAYSDEVDIR/templates/scripts" "2")" -ne 0 ]; then
    printf_green "Setting up the Scripts directory"
    __cp_rf "$CASJAYSDEVDIR/templates/scripts/." "$HOME/.config/gen-script/files/"
  else
    printf_exit "1" "1" "No scripts exist"
  fi
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Application functions
__date() { date +"$1"; }
__filename() { __basename "$1" 2>/dev/null; }
__dirname() { __basedir "$1" 2>/dev/null; }

# Set up options
__header_opts() {
  printf_blue "Setting header options"
  local t=$(getopt -o h,d:,t:,c:,o:,r:,i:,f --long help,desc:,todo:,copy:,other:,res:,type:,funct*: -n "$APPNAME" -- "$@" 2>/dev/null)
  eval set -- "$t" 2>/dev/null
  while :; do
    case "$1" in
    -h | --help)
      shift
      __gen_header_help
      ;;
    -f | --funct*)
      showFunctions=true
      ;;
    -d | --desc)
      shift
      desc="$1"
      ;;
    -t | --todo)
      shift
      todo="$1"
      ;;
    -c | --copy)
      shift
      GEN_SCRIPTS_COPYRIGHT="$1"
      ;;
    -o | --other)
      shift
      other="$1"
      ;;
    -r | --res)
      shift
      res="$1"
      ;;
    -i | --type)
      shift
      type="$1"
      ;;
    --)
      shift
      break
      ;;
    *)
      break
      ;;
    esac
    shift
  done
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__config() {
  printf_green "Generating the config and saving it to:"
  printf_cyan "$HOME/.config/gen-script/settings"
  __rm_rf "$HOME/.config/gen-script/settings"
  cat <<EOF >>"$HOME/.config/gen-script/settings"
GEN_SCRIPTS_EMAIL="$GEN_SCRIPTS_EMAIL"
GEN_SCRIPTS_AUTHOR="$GEN_SCRIPTS_AUTHOR"
GEN_SCRIPTS_COMPANY="$GEN_SCRIPTS_COMPANY"
GEN_SCRIPTS_VERSION="%m%d%Y%H%M-git"
GEN_SCRIPTS_DEFREADME="README"
GEN_SCRIPTS_DEFLICENSE="WTFPL"
GEN_SCRIPTS_DATEFMT="%A, %b %d, %Y %H:%M %Z"
GEN_SCRIPTS_TEMPLATE_DIR="$GEN_SCRIPTS_TEMPLATE_DIR"
GEN_SCRIPTS_COPYRIGHT="Copyright: (c) $GEN_SCRIPTS_YEAR $GEN_SCRIPTS_AUTHOR, $GEN_SCRIPTS_COMPANY"

EOF
  [ $? = 0 ] && printf_green "Settings have been saved" || printf_error "Failed to save the settings"
}

__copy_templates() {
  if [ -d "$HOME/.config/gen-script/files/.git" ]; then
    git -C "$HOME/.config/gen-script/files" pull -q
  else
    printf_green "Copying the files from:"
    printf_green "$CASJAYSDEVDIR/templates/scripts to $HOME/.config/gen-script/files"
    __cp_rf "$CASJAYSDEVDIR/templates/scripts/." "$HOME/.config/gen-script/files/"
  fi
  [ $? -eq 0 ] && [ -d "$HOME/.config/gen-script/files" ] &&
    printf_green "Install has succeeded" || printf_red "Install of the files failed"
}

__makefile() {
  local temp="$1"
  local new="$2"
  local newdir="$(__dirname "$new")"
  shift 2
  __mkd "$newdir"
  __vars "$new"
  __cp_rf "$temp" "$new" || return 1
  __edit_header "$new" || return 1
  chmod -f 755 "$new" || return 1
  [ $? -ne 0 ] && printf_red "Failed to create $new" && return 1 || printf_green "Your file has been created"
  return $?
}

__edit_header() {
  local GEN_SCRIPTS_NEWFILE="$1"
  local GEN_SCRIPTS_NEWFILEDIR="$(__basename $GEN_SCRIPTS_NEWFILE)"
  __vars "$*"
  [ -f "$GEN_SCRIPTS_NEWFILE" ] && printf_green "Editing the header info" || printf_exit 1 1 "Failed to created the file"
  sed -i 's#REPLACE_APPNAME#'${GEN_SCRIPTS_NEWFILEDIR##*/}'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_COPYRIGHT#'"$GEN_SCRIPTS_COPYRIGHT"'#g' "$GEN_SCRIPTS_NEWFILE"
  sed -i 's#REPLACE_VERSION#'"$(__date "$GEN_SCRIPTS_VERSION" 2>/dev/null)"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_FILENAME#'"$(__filename "$GEN_SCRIPTS_NEWFILE" 2>/dev/null)"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_VERSION#'"$(__date "$GEN_SCRIPTS_VERSION" 2>/dev/null)"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_DATE#'"$(__date "$GEN_SCRIPTS_DATEFMT" 2>/dev/null)"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_LICENSE#'"$GEN_SCRIPTS_DEFLICENSE"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_README#'"$GEN_SCRIPTS_DEFREADME"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_AUTHOR#'"$GEN_SCRIPTS_AUTHOR"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_EMAIL#'"$GEN_SCRIPTS_EMAIL"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_YEAR#'"$GEN_SCRIPTS_YEAR"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  #
  sed -i 's#REPLACE_DESC#'"$desc"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_TODO#'"$todo"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_OTHER#'"$other"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null
  sed -i 's#REPLACE_RES#'"$res"'#g' "$GEN_SCRIPTS_NEWFILE" 2>/dev/null

  return $?
}

__gen_header_help() {
  printf_blue "-d: Description"
  printf_blue "-t: TODO"
  printf_blue "-c: Copyright"
  printf_blue "-o: Other"
  printf_blue "-r: Resources"
  printf_blue "-f: Include functions"
  printf_blue "-i: Install function to use - user_install"
  printf_yellow "Types: user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr"
  printf_yellow 'IE: gen-script header filename -d "My Descr" -c "My Copy" -t "My TODO" -o "OTHER" -r "RESOURCE" -i "system" -f'
  exit 0
}
__gen_header() {
  __vars "$filename"
  __header_opts "$@"
  printf_green "New header info for $filename"
  local GEN_SCRIPTS_DEFREADME="$filename --help"
  local GEN_SCRIPTS_NEWFILE="$filename"
  [ -n "$desc" ] || printf_yellow "Description: ${desc:-None provided}"
  [ -n "$todo" ] || printf_yellow "TODO: ${todo:-None provided}"

  echo '#!/usr/bin/env bash

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
PROG="'"$(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)"'"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts
'

  cat <<EOF | tee
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $(__date "${GEN_SCRIPTS_VERSION}" 2>/dev/null)
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $GEN_SCRIPTS_DEFREADME
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $(__date "${GEN_SCRIPTS_DATEFMT}" 2>/dev/null)
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-}
# @TODO          : ${todo:-}
# @Other         : ${other:-}
# @Resource      : ${res:-}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
EOF
  if [ "$showFunctions" = true ]; then __gen_functions; else printf_newline "\n\n"; fi
  printf_blue "Your header is ready for use\n\n"
}

__gen_functions() {
  __vars "$@"
  echo '# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
'${type:-user}_install'
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
'
}

__vars() {
  [ -f "$topdir/README.md" ] && GEN_SCRIPTS_DEFREADME="README.md" || GEN_SCRIPTS_DEFREADME="$(basename "$1" 2>/dev/null) --help"
  [ -f "$topdir/LICENSE.md" ] && GEN_SCRIPTS_DEFLICENSE="LICENSE.md" || GEN_SCRIPTS_DEFLICENSE="$GEN_SCRIPTS_DEFLICENSE"
  [ -f "$topdir/version.txt" ] && GEN_SCRIPTS_VERSION="$(cat $topdir/version.txt 2>/dev/null)" || GEN_SCRIPTS_VERSION="$GEN_SCRIPTS_VERSION"
}

__find_file() {
  arg1=${1// /\/}
  arg2=${2// /\/}
  arg3=${3// /\/}
  if [ -f "$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/$arg2/${arg3:-default}" ]; then
    template="$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/$arg2/${arg3:-default}"
    [[ "$4" = -* ]] && dest="newScript" || dest="$4"
    shift 3
  elif [ -f "$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/${arg2:-default}" ]; then
    template="$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/${arg2:-default}"
    [[ "$3" = -* ]] && dest="newScript" || dest="$3"
    shift 2
  elif [ -f "$GEN_SCRIPTS_TEMPLATE_DIR/${arg1:-default}" ]; then
    template="$GEN_SCRIPTS_TEMPLATE_DIR/${arg1:-default}"
    [[ "$2" = -* ]] && dest="newScript" || dest="$2"
    shift 1
  else
    printf_green "Using the default template: bash"
    template="$GEN_SCRIPTS_TEMPLATE_DIR/shell/bash"
    [[ "$1" = -* ]] && dest="newScript" || dest="$1"
  fi
  dest="${dest:-newScript}"
  __header_opts "$dest" "$@"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[ -f "$HOME/.config/gen-script" ] && __rm_rf "$HOME/.config/gen-script" || __mkd "$HOME/.config/gen-script"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main application
case "$1" in
*config)
  shift 1
  __config
  __copy_templates "$@"
  exit
  ;;

*funct*)
  shift 1
  [ $# -lt 2 ] || printf_exit "Only takes a filename as an argument"
  printf_green "New functions info for ${1:-template}"
  __gen_functions ${1:-template}
  printf_green "End of functions"
  exit
  ;;

*header)
  shift 1
  [[ "$1" != -* ]] && filename="$1" && shift 1 || filename="template"
  __gen_header "$@"
  exit
  ;;

*installers)
  case "$2" in
  *)
    __find_file "$@"
    ;;
  esac
  ;;

*os)
  case "$2" in
  *) ## Allows drop in without need to update this
    __find_file "$@"
    ;;
  esac
  ;;

*shell)
  case "$2" in
  *) ## Allows drop in without need to update this
    __find_file "$@"
    ;;
  esac
  ;;

*all) ## Bash Completion
  shift 1
  __find_file "$@"
  ;;

*) ## Allows drop in without need to update this
  __find_file "$@"
  ;;
esac
shift

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sanity check
[ -f "$template" ] || printf_exit 1 1 "The template file doesn't exist: $template"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# file and folder setup
filename="$(__basename ${dest:-newScript} 2>/dev/null || echo .)"
destfolder="$(__basedir $dest 2>/dev/null)"
# # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Generate the file
if [ "$filename" = "newScript" ]; then
  printf_read_question "3" "What should we name this ?" "120" "tmpfilename"
  tmpfilename="${tmpfilename:-$filename}"
else
  tmpfilename="$filename"
fi
filename=${tmpfilename// /_}
if [ -f "$destfolder/$filename" ] && [ -z "$OVERWRITE" ]; then
  printf_read_question "3" "Should we overwrite this file?" "1" "YN" "-s"
  printf_answer_yes "$YN" || printf_exit 1 1 "Refusing to overwrite existing file!"
fi
printf_green "Copying the file ${template//$GEN_SCRIPTS_TEMPLATE_DIR\//} to $destfolder/$filename"
__makefile "${template:?}" "$destfolder/$filename" || printf_exit 1 1 "Failed to create $destfolder/$filename"
[ -n "$OPENEDIT" ] || printf_read_question "3" "Should we edit this file?" "1" "EDIT" "-s"
printf_answer_yes "$EDIT" && $EDITOR "$destfolder/$filename"
printf_newline ""
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit $?
# end
