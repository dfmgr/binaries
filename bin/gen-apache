#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : gen-apache
# @Created     : Wed, Aug 05, 2020, 02:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : Generate an apache host
# @Source      :
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
system_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
TMP_DIR="$(mktemp -d /tmp/apacheXXX)"
TMP_FILE="$(mktemp $TMP_DIR/apacheXXX.conf)"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__return__error() {
  printf_error "Somethings seems to have gone very wrong"
  printf_yellow "File has been saved to $TMP_FILE"
  printf_exit 1 1
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__apache_confdir() {
  if [ -d /etc/apache2/sites-enabled ]; then
    apacheconfdir="/etc/apache2/sites-enabled"
  elif [ -d "/etc/httpd/conf/vhosts.d" ]; then
    apacheconfdir="/etc/httpd/conf/vhosts.d"
  else
    printf_read_question "4" "Where are your apache server files located?" "120" apacheconfdir
    if [[ ! -d "$apacheconfdir" ]]; then
      if user_is_root; then
        printf_read_question "4" "The directory doesn't exist should I try to create it?"
        if printf_answer_yes; then __mkd "$apacheconfdir"; fi
      fi
      printf_error "Can not create $apacheconfdir"
    fi
  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__apache_dom() {
  printf_read_question "4" "What is your domain name?" "120" APACHEDOMAIN
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__apache_www() {
  printf_read_question "4" "What is your DocumentRoot?" "120" APACHEDOCROOT
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__apache_html() {
  __mkd "$TMP_DIR/www"
  __cp_rf "$CASJAYSDEVDIR/templates/apache/html/." "$TMP_DIR/www/"
  find "$TMP_DIR" -type f -exec sed -i 's#REPLACE_WITHDOM#'"${APACHEDOMAIN}"'#g' {} \; >/dev/null 2>&1
  find "$TMP_DIR" -type f -exec sed -i 's#REPLACE_HTMLROOT#'"${APACHEDOCROOT}"'#g' {} \; >/dev/null 2>&1
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__apache_conf() {
  if [ -d /etc/letsencrypt/live/domain ] || [ -d "/etc/letsencrypt/live/$(hostname -f)" ]; then
    if [ -d "/etc/letsencrypt/live/$(hostname -f)" ]; then
      [ -d /etc/letsencrypt/live/domain ] || __ln_sf "/etc/letsencrypt/live/$(hostname -f)" /etc/letsencrypt/live/domain
    fi
    cat <<EOF >"$TMP_FILE"
# VirtualHost for $APACHEDOMAIN

<IfModule mod_ssl.c>
<VirtualHost _default_:8443>
ServerName $APACHEDOMAIN
ServerAdmin webmaster@$APACHEDOMAIN
DocumentRoot "$APACHEDOCROOT"

#Rewrites
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]

##LE Certs
SSLEngine on
SSLCertificateFile /etc/letsencrypt/live/domain/cert.pem
SSLCertificateKeyFile /etc/letsencrypt/live/domain/privkey.pem
SSLCertificateChainFile /etc/letsencrypt/live/domain/fullchain.pem

#Headers
#Header always set Strict-Transport-Security "max-age=31536000; preload"
#RequestHeader set Connection ""
#RequestHeader set Upgrade $http_upgrade;
#RequestHeader set Connection "upgrade"
#RequestHeader set X-Forwarded-Proto "https"
</VirtualHost>
</IfModule>
EOF
  else
    cat <<EOF >"$TMP_FILE"
# VirtualHost for $APACHEDOMAIN

<IfModule mod_ssl.c>
<VirtualHost _default_:8443>
ServerName $APACHEDOMAIN
ServerAdmin webmaster@$APACHEDOMAIN
DocumentRoot "$APACHEDOCROOT"

#Rewrites
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]

SSLEngine on
SSLCertificateFile /etc/ssl/CA/CasjaysDev/certs/localhost.crt
SSLCertificateKeyFile /etc/ssl/CA/CasjaysDev/private/localhost.key
#SSLCertificateChainFile /etc/ssl/CA/CasjaysDev/certs/localhost.crt

#Headers
#Header always set Strict-Transport-Security "max-age=31536000; preload"
#RequestHeader set Connection ""
#RequestHeader set Upgrade $http_upgrade;
#RequestHeader set Connection "upgrade"
#RequestHeader set X-Forwarded-Proto "https"
</VirtualHost>
</IfModule>
EOF
  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APACHEDOMAIN="${APACHEDOMAIN:-$1}"
APACHEDOCROOT="${APACHEDOCROOT:-$2}"

if [ -z "$apacheconfdir" ]; then
  __apache_confdir
fi

if [ -z "$APACHEDOMAIN" ]; then
  __apache_dom
fi

if [ -z "$APACHEDOCROOT" ]; then
  __apache_www
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
printf_green "Setting up $APACHEDOMAIN in $TMP_FILE"
__apache_conf "$@"
printf_green "Copying the template html files to $TMP_FILE"
__apache_html

# move files if root
if user_is_root; then
  if [ -n "$(grep $APACHEDOMAIN /etc/hosts 2>/dev/null)" ]; then
    echo "127.0.0.1      $APACHEDOMAIN" >>/etc/hosts
  fi
  if [ -f "$TMP_FILE" ]; then
    printf_green "Installing $TMP_FILE to $apacheconfdir/$APACHEDOMAIN.conf"
    __mv_f "$TMP_FILE" "$apacheconfdir/$APACHEDOMAIN.conf" && __mv_f "$TMP_DIR/www/" "$APACHEDOCROOT"
    [ "$?" = 0 ] && printf_green "Everything has been setup" || __return__error
  else
    __return__error
  fi
else
  printf_green "The config file has been generated and saved to $TMP_FILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit $?
#End
