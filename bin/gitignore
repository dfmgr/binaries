#!/usr/bin/env bash

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
PROG="gitignore"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 021420212105-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.com
# @License       : WTFPL
# @ReadME        : gitignore --help
# @Copyright     : Copyright: (c) 2021 Jason Hempstead, CasjaysDev
# @Created       : Sunday, Feb 14, 2021 21:05 EST
# @File          : gitignore
# @Description   : Generate a .gitignore file
# @TODO          : Make this work locally
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
user_install
__options "$@"
__check_app git
__check_app curl
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
GITIGNOREURL="${GITIGNOREURL:-https://www.toptal.com/developers/gitignore/api}"
IGNORELIST="$(echo "$@" | tr ' ' ',')"
GITDIR="$(git rev-parse --show-toplevel 2>/dev/null)"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[ -n "$1" ] || __help
[[ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" == "true" ]] || printf_exit 2 0 "This is not a git repo"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
set_gitignoredir() {
  if [[ $* =~ dirignore ]]; then
    shift 1
    if ! cat "$GITDIR/.gitignore" 2>/dev/null | grep -Fvq 'ignoredirmessage'; then
      printf "# Disable reminder in prompt\nignoredirmessage\n\n" >>"$GITDIR/.gitignore"
      #printf_green "Added ignoredirmessage to your .gitignore"
    fi
  fi
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
fetch_ignore() {
  gi_args=()
  for arg; do
    if [[ $arg = -- ]]; then
      curl_args=("${gi_args[@]}")
      gi_args=()
    else
      gi_args+=("$arg")
    fi
  done
  IFS=,
  __curl "${curl_args[@]}" "$GITIGNOREURL/${gi_args[*]}"
  echo ""
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
ignore_overwrite() {
  if [[ $* = "--automated" ]]; then
    shift 1
    overwrite=Y
  fi
  if [ -f "$GITDIR/.gitignore" ] && [ -z "$overwrite" ]; then
    printf_read_question "2" "Should I overwrite your git ignore? [y/n]" "1" "overwrite" "-s"
    if printf_answer_yes "$overwrite"; then
      __rm_rf "$GITDIR/.gitignore"
    else
      printf_red "User aborted, not overwriting your .gitignore"
      exit 1
    fi
  fi
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
create_gitignore() {
  fetch_ignore "$@" >>"$GITDIR/.gitignore"
  printf_green "Added $IGNORELIST to your .gitignore"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

case $* in
--help)
  __help
  exit
  ;;
--list)
  cat "${SCRIPTSFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}/helpers/gitignore/array" | printf_columns
  exit
  ;;
--console)
  shift 1
  printf_green "$(fetch_ignore "$@")"
  exit
  ;;
*dirignore)
  set_gitignoredir "$@"
  ;;
*)
  ignore_overwrite "$@"
  set_gitignoredir "$@"
  [ $# -ne 0 ] && create_gitignore "$@" || exit
  ;;
esac
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit $?
# end
