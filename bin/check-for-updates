#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="check-for-updates"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
SRC_DIR="${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 202103200340-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.com
# @License       : WTFPL
# @ReadME        : check-for-updates --help
# @Copyright     : Copyright: (c) 2021 Jason Hempstead, CasjaysDev
# @Created       : Saturday, Mar 20, 2021 03:40 EDT
# @File          : check-for-updates
# @Description   : Check for package updates
# @TODO          : Add brew/choco support
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
user_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "/usr/local/bin/dmenupass" ]; then
  SUDO_ASKPASS="/usr/local/bin/dmenupass}"
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
updatemess="You have updates available \nWould you like to update now?"
xmessageopts="-nearmouse -timeout 10 -geometry 500x200 -center"
notifications="${UPDATE_NOTIFY:-yes}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[ -d "${TMPDIR:-$HOME/.local/tmp}" ] || __mkd "${TMPDIR:-$HOME/.local/tmp}"
[ -f "${TMPDIR:-$HOME/.local/tmp}/update_check" ] || __rm_rf "${TMPDIR:-$HOME/.local/tmp}/update_check"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if ! __am_i_online; then
  echo "0"
  echo "$updates" >"$HOME/.local/tmp/update_check"
  exit
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Arch update check
if [ -f /usr/bin/pacman ]; then
  if ! updates_arch=$(pacman -Qu 2>/dev/null | wc -l); then
    updates_arch=0
  fi
  # yay doesn't do sudo
  if [ -f /usr/bin/yay ]; then
    if ! updates_aur=$(yay -Qum 2>/dev/null | wc -l); then
      updates_aur=0
    fi
  fi
  updates=$(("$updates_arch" + "$updates_aur"))
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Debian/Ubuntu update check
elif [ -f /usr/bin/apt ]; then
  if ! updates=$(sudo apt-get update >/dev/null && apt-get --just-print upgrade | grep "Inst " | wc -l); then
    updates=0
  fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Fedora/RedHat/CentOS
elif [ -f /usr/bin/dnf ]; then
  if ! updates=$(sudo dnf check-update -q | grep -v Security | wc -l); then
    updates=0
  fi
elif [ -f /usr/bin/yum ]; then
  if ! updates=$(sudo yum check-update -q | grep -v Security | wc -l); then
    updates=0
  fi
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ "$updates" -gt 0 ]; then
  echo " $updates"
else
  echo "0"
  rm -Rf "$HOME/.local/tmp/update_check"
  exit 0
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#if [ ! -f "$HOME/.cache/update_nag" ] && [ -n "$DISPLAY" ]; then
#DISPLAY=$DISPLAY xmessage -buttons Yes:0,No:1 -default Yes $xmessageopts --title "You have updates" "$updatemess" && \
#sleep 20 && #pkmgr silent update && \
#DISPLAY=$DISPLAY xmessage -buttons OK:0 -default Ok $xmessageopts --title "Done updating" "Update completed successfully" && \
#sleep 20
#DISPLAY=$DISPLAY xmessage -buttons Yes:0,No:1 -default Yes $xmessageopts --title "message" "Show this again?" && \
#sleep 20 ; ret=$? ; if [ "$ret" -ne 0 ]; then touch $HOME/.cache/update_nag ; fi
#fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
echo "$updates" >"$HOME/.local/tmp/update_check"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [[ "$1" =~ notify ]] || [ "$UPDATE_NOTIFY" = "yes" ]; then
  if [ "$updates" -gt 0 ]; then
    if [ -f /usr/local/bin/notifications ]; then
      if [ ! -f "$HOME/.local/tmp/update_check" ]; then
        /usr/local/bin/notifications "System Updates:" "You have $updates update[s] avaliable"
      fi
    fi
  fi
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end
