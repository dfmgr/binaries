#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : dockermgr
# @Created     : Wed, Aug 05, 2020, 02:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : docker script to manage containers
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Set functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-applications.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
else
  mkdir -p "/tmp/CasjaysDev/functions"
  curl -LSs "$SCRIPTSFUNCTURL/$SCRIPTSFUNCTFILE" -o "/tmp/CasjaysDev/functions/$SCRIPTSFUNCTFILE" || exit 1
  . "/tmp/CasjaysDev/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

[ "$1" = "--version" ] && get_app_info "$APPNAME"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

API="$(curl -s "https://api.github.com/orgs/dockermgr/repos?per_page=1000" | jq -r '.[] | .name' 2>/dev/null)"
HOMEDIR="${HOMEDIR:-/srv/docker}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__help() {
  printf_green "Scripts to setup docker containers"
  exit 1
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__init() {
  if ! cmd_exists docker; then
    bash -c "$(curl -fsSL https://get.docker.com)" || printf_exit "Installation has failed"
  fi
  if grep -q docker /etc/group; then
    sudo usermod -aG docker "$USER"
    sudo chown "$USER":"$USER" /home/"$USER"/.docker -R
    sudo chmod g+rwx "$HOME/.docker" -R
  fi

  if [ ! -f /etc/systemd/system/docker.service.d/docker.conf ]; then
    sudo mkdir -p /etc/systemd/system/docker.service.d
    cat <<EOF | sudo tee -a /etc/systemd/system/docker.service.d/docker.conf
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock
EOF
  fi
  sudo systemctl enable docker --now
}

__init_help() {
  printf_green "Setup docker"
  exit 1
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__install() {
  git clone -q "$1" "$HOMEDIR/$1"
  bash -c "$HOMEDIR/$1/install.sh"
  if [ -d "$HOMEDIR/$1/os" ]; then
    sudo cp -Rf "$HOMEDIR/$1/os/." /
  fi
}

__install_help() {
  printf_green "Usage: $APPNAME install NAME    |    $APPNAME install transmission"
  exit 1
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__run_help() {
  printf_green "Usage: dockerrun imageName"
  printf_green "See http://hub.docker.com for images"
  exit 1
}

__run_main() {
  NAME="$(echo $1 | sed 's/[!@#\$%^&*():]//g')"
  if [ "$(sudo docker ps -q -f status=running -f name=^/${NAME}$)" ]; then
    sudo docker container exec -it "$NAME" /bin/bash -l
  else
    sudo docker run -d --network host -it --name $NAME --restart always "$1" /sbin/init &&
      sudo docker container exec -it "$NAME" /bin/bash -l
  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__ssh_help() {
  printf_green "Auto connect to first container if none are specified"
  printf_green "Usage: docker-ssh container_name"
  exit 1
}

__ssh_error() {
  printf_red "There are no running containers"
  exit 1
}

__ssh_main() {
  CONTAINER="$1"
  if [[ "$CONTAINER" == "" ]]; then
    CONTAINER=$(docker ps | grep -Eo "^[0-9a-z]{8,}\b") || __ssh_error
  fi
  docker exec -i -t "$CONTAINER" bash -l
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

[ "$1" = "--help" ] && __help

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

case "$1" in

init)
  shift
  [ "$1" = "--help" ] && __init_help
  __init "$@"
  ;;

install)
  shift
  [ "$1" = "--help" ] && __init_help
  __install "$@"
  ;;

ssh)
  shift
  [ "$1" = "--help" ] && __ssh_help
  __ssh_main "$@"
  ;;

run)
  shift
  [ "$1" = "--help" ] && __run_help
  __run_main "$@"
  ;;

*)
  __help
  ;;

esac

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# End
