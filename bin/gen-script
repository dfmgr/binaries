#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="$(basename "$0")"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
SRC_DIR="${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 202103200738-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.com
# @License       : WTFPL
# @ReadME        : gen-script --help
# @Copyright     : Copyright: (c) 2021 Jason Hempstead, CasjaysDev
# @Created       : Saturday, Mar 20, 2021 07:38 EDT
# @File          : gen-script
# @Description   : Create a script from template
# @TODO          : Reactor code/Group Functions/Create separate gen-header script
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
user_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# I'm sure there is a better way to do this
if [ -d "$1" ]; then
  MYCURRDIR="$1"
  shift 1
elif [ "$1" = "-d" ] || [ "$1" = "-dir" ] || [ "$1" = "--dir" ]; then
  MYCURRDIR="$2"
  shift 2
  [ -d "$MYCURRDIR" ] || printf_exit "$MYCURRDIR doesn't seem to be a directory"
else
  MYCURRDIR="$PWD"
fi
if [ "$MYCURRDIR" = "." ]; then MYCURRDIR="$(__basedir ".")"; fi
if [ "$1" = "--skip" ]; then OVERWRITE="Y" && OPENEDIT="N" && shift 1; fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# default variables
topdir="$(__git_top_dir "$MYCURRDIR" || echo $MYCURRDIR 2>/dev/null)"
GEN_SCRIPTS_YEAR="$(date +%Y 2>/dev/null)"
GEN_SCRIPTS_EMAIL="${USER}"
GEN_SCRIPTS_AUTHOR="${USER}"
GEN_SCRIPTS_COMPANY="${USER}"
GEN_SCRIPTS_VERSIONFMT="${VERSION_DATE_FORMAT:-%Y%m%d%H%M-git}"
GEN_SCRIPTS_DEFREADME="README"
GEN_SCRIPTS_DEFLICENSE="WTFPL"
GEN_SCRIPTS_DATEFMT="%A, %b %d, %Y %H:%M %Z"
GEN_SCRIPTS_COPYRIGHT="Copyright: (c) $GEN_SCRIPTS_YEAR $GEN_SCRIPTS_AUTHOR, $GEN_SCRIPTS_COMPANY"
GEN_SCRIPTS_CURRENT_DIR="$MYCURRDIR"
GEN_SCRIPTS_OPTSDIR="$HOME/.local/share/gen-script"
GEN_SCRIPTS_CONFIG_DIR="$HOME/.config/gen-script"
GEN_SCRIPTS_BACKUP_DIR="$GEN_SCRIPTS_CONFIG_DIR/backups"
GEN_SCRIPTS_COPY_CONFIRM="${GEN_SCRIPTS_COPY_CONFIRM:-yes}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -d "$GEN_SCRIPTS_CONFIG_DIR/files" ]; then
  GEN_SCRIPTS_TEMPLATE_DIR="$GEN_SCRIPTS_CONFIG_DIR/files"
else
  GEN_SCRIPTS_TEMPLATE_DIR="${GEN_SCRIPTS_TEMPLATE_DIR:-$CASJAYSDEVDIR/templates/scripts}"
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$GEN_SCRIPTS_CONFIG_DIR/settings.conf" ]; then
  . "$GEN_SCRIPTS_CONFIG_DIR/settings.conf"
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
GEN_SCRIPTS_VERSION="$(date +"${GEN_SCRIPTS_VERSIONFMT}" 2>/dev/null)"
GEN_SCRIPTS_CREATED="$(date +"${GEN_SCRIPTS_DATEFMT}" 2>/dev/null)"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Application functions
__filename() { basename "$1" 2>/dev/null; }
__dirname() { if [ "$(dirname "$1" 2>/dev/null)" = . ]; then echo "$PWD"; else dirname "$1" 2>/dev/null; fi; }
__sed() { sed -i 's|'"$1"'|'"$2"'|g' "$3" 2>/dev/null; }
__providefilename() { [ -f "$(__fullfilename "${1:-$filename}")" ] || printf_exit "Please provide a filename"; }
__remove_opts() { echo "$*" | tr ' ' '\n' | grep -sv '^-' | head -n1 | grep '^' || return 1; }
__gen_confdir() { echo "$1" | tr [a-z] [A-Z] | sed 's#-#_#g;s# #_#g;s/\./_/g'; }
__print_wait() { printf_pause "$*" && printf_newline "\n"; }
__prev_readme() { grep -sR ^'printf_help "." ' "$1"; }
__grep() { grep -sE ^'.*#?@'${2:-$headerfield}'.*  :' "${3:-$filename}" | grep -Ev '${.*}|\$|GEN_SCRIPTS_' | head -n1 | grep ${1:-} '^' || return 1; }
__fullfilename() {
  if [ -f "$1" ]; then
    ls -A "$1" 2>/dev/null
  else
    type -P "$(basename "$1")" 2>/dev/null
  fi
}
__get_header() {
  local PATH="/usr/local/bin:/usr/bin:/usr/sbin:/$HOME/.local/bin"
  local command="$(__fullfilename "$filename")"
  if [ -f "$command" ] && __check_header "$command"; then
    if [ "$1" = "all" ]; then
      shift 1
      printf "# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n"
      grep -sE ^'.*#.@'*'.*  :' "$command" 2>/dev/null | grep -Ev '${.*}|\$|GEN_SCRIPTS_' | head -n${1:-14} | grep '^' || return 1
      printf "# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n"
    elif [ "$1" = "prev" ]; then
      shift 1
      grep -sE ^'.*#.@'*'.*  :' -B1 -A1 "$command" 2>/dev/null | head -n${1:-14} | grep -Ev '${.*}|\$|GEN_SCRIPTS_' | grep '^' || return 1
    else
      local search="$1"
      local command="${2:-$command}"
      grep -sE ^'.*#.@'$1'' "$command" 2>/dev/null | grep ' :' | grep -Ev '${.*}|\$|GEN_SCRIPTS_' | head -n1 | sed 's/.*#.@'*'.*  ://g;s#^ ##g' | grep '^' || return 1
    fi
  fi
}
__check_header() {
  local PATH="/usr/local/bin:/usr/bin:/usr/sbin:/$HOME/.local/bin:$PWD"
  local command="$(__fullfilename "${command:-$filename}")"
  grep -s ^'.*##@Version.*:' "$(__fullfilename "${command:-$filename}")" 2>/dev/null | grep '   :' | \
    grep -Ev '${.*}|\$|GEN_SCRIPTS_' | head -n1 | grep -q '^' || return 1
}
#__update_header "$file" "$search" "$replace"
__update_header() {
  #printf_exit "$1 $2 $3"
  local filename="$1"
  local headerfield="$2"
  local replace="$3"
  if __grep -q; then
    local search="$(__grep | head -n1 | awk -F': ' '{print $2}' | grep '^')"
    if [ -z "$search" ]; then
      search="$(__grep)"
      replace="$search$replace"
    fi
    #sed -i 's#'"$search"'#'"$replace"'#g' "$filename" 2>/dev/null
    __sed "$search" "$replace" "$filename" &&
      printf_green "Changed $headerfield to $replace" ||
      printf_red "Change $headerfield to $replace has failed"
  else
    printf_exit "Failed to change $search to $3 pattern was not found"
  fi
}
__get_prev() {
  local PATH="/usr/local/bin:/usr/bin:/usr/sbin:/$HOME/.local/bin"
  local command="$(__fullfilename "$filename")"
  if [ -f "$command" ] && __check_header "$command"; then
    [ -n "$get_prev_shown" ] || printf_green "setting desc todo other and res from $(basename "$command" 2>/dev/null)"
    get_desc="$(__get_header 'Description')"
    get_todo="$(__get_header 'TODO')"
    get_other="$(__get_header 'Other')"
    get_res="$(__get_header 'Resource')"
  fi
  get_prev_shown=true
}
# Current file info
__prev_header() {
  __get_header "prev" #|| __no_header
}
__replace_header() {
  local PATH="/usr/local/bin:/usr/bin:/usr/sbin:/$HOME/.local/bin"
  __get_prev
  if [ -n "$filename" ]; then
    printf "Version: %s | Created: %s\n" "$GEN_SCRIPTS_VERSION" "$GEN_SCRIPTS_CREATED"
    __get_header "all"
  else
    [ -n "$desc" ] || desc="$get_desc"
    [ -n "$todo" ] || todo="$get_todo"
    [ -n "$other" ] || other="$get_other"
    [ -n "$res" ] || res="$get_other"
    cat <<EOF | tee
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $GEN_SCRIPTS_VERSION
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $GEN_SCRIPTS_DEFREADME
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $GEN_SCRIPTS_CREATED
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-}
# @TODO          : ${todo:-}
# @Other         : ${other:-}
# @Resource      : ${res:-}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
EOF
  fi
}
__no_header() {
  unset gen_header_prev gen_header_replace exitCode
  rerun=true
  printf_red "No header info was found: Using defualt"
  __gen_header "${filename:-command}"
  exit $?
}
__set_header() {
  __header_opts "$@"
  printf_blue "Setting header options for ${header_type:-system}"
}
# Set up options
__header_opts() {
  local LONGOPTS="all:,no,help,user,raw,desc:,todo:,copy:,other:,res:,type:,functions:,name:,prev,replace,keep,pause"
  local SHORTOPTS="a:,e,h,d:,t:,c:,o:,r:,i:,f,n:,u,l:,p,k"
  local parsed=$(getopt --options="$SHORTOPTS" --longoptions="$LONGOPTS" -- "$@" 2>/dev/null)
  eval set -- "${parsed[@]}" 2>/dev/null
  while :; do
    case "$1" in
    -h | --help)
      __gen_header_help
      ;;
    -a | --all)
      shift 1
      if [ "$1" = "--long" ]; then echo "--$LONGOPTS " | sed 's#:##g;s#,# --#g'; fi
      if [ "$1" = "--short" ]; then echo "-$SHORTOPTS " | sed 's#:##g;s#,# -#g'; fi
      if [ "$1" = "--all" ]; then
        echo -n "-$SHORTOPTS " | sed 's#:##g;s#,# -#g'
        echo -n "--$LONGOPTS " | sed 's#:##g;s#,# --#g'
      fi
      return 0
      ;;
    -f | --functions)
      showFunctions=true
      ;;
    -d | --desc)
      shift 1
      desc="$1"
      ;;
    -t | --todo)
      shift 1
      todo="$1"
      ;;
    -c | --copy)
      shift 1
      GEN_SCRIPTS_COPYRIGHT="$1"
      ;;
    -o | --other)
      shift 1
      other="$1"
      ;;
    -r | --res)
      shift 1
      res="$1"
      ;;
    -i | --type)
      shift 1
      type="$1"
      ;;
    -p | --prev)
      gen_header_prev=true
      ;;
    -n | --name)
      shift 1
      GEN_FILENAME="$1"
      ;;
    -u | --user)
      header_type=user
      gen_header_user=true
      ;;
    -l | --license)
      shift 1
      GEN_SCRIPTS_CUSTOM_LICENSE="true"
      GEN_SCRIPTS_DEFLICENSE="$1"
      ;;
    -e | --no)
      printf_red "Setting overwrite to yes and edit to no"
      OVERWRITE="Y"
      EDITFILE="N"
      MAKEFILE="${MAKEFILE:-yes}"
      ;;
    -k | --keep)
      printf_red "Setting overwrite to no and edit to no"
      OVERWRITE="N"
      EDITFILE="N"
      MAKEFILE="N"
      ;;
    --replace)
      gen_header_replace=true
      ;;
    --raw)
      gen_header_raw=true
      ;;
    --pause)
      pause=true
      ;;
    --)
      break
      ;;
      #*)
      #  break
      #  ;;
    esac
    shift
  done
  HEADER_ARGS="$*"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__gen_config() {
  printf_green "Generating the config and saving it to:"
  printf_cyan "$GEN_SCRIPTS_CONFIG_DIR/settings.conf"
  __rm_rf "$GEN_SCRIPTS_CONFIG_DIR/settings.conf"
  cat <<EOF >>"$GEN_SCRIPTS_CONFIG_DIR/settings.conf"
GEN_SCRIPTS_COPY_CONFIRM="yes"
GEN_SCRIPTS_EMAIL="$GEN_SCRIPTS_EMAIL"
GEN_SCRIPTS_AUTHOR="$GEN_SCRIPTS_AUTHOR"
GEN_SCRIPTS_COMPANY="$GEN_SCRIPTS_COMPANY"
GEN_SCRIPTS_VERSIONFMT="${VERSION_DATE_FORMAT:-%Y%m%d%H%M-git}"
GEN_SCRIPTS_DEFREADME="README"
GEN_SCRIPTS_DEFLICENSE="WTFPL"
GEN_SCRIPTS_DATEFMT="%A, %b %d, %Y %H:%M %Z"
GEN_SCRIPTS_TEMPLATE_DIR="$GEN_SCRIPTS_TEMPLATE_DIR"
GEN_SCRIPTS_COPYRIGHT="Copyright: (c) $GEN_SCRIPTS_YEAR $GEN_SCRIPTS_AUTHOR, $GEN_SCRIPTS_COMPANY"
GEN_SCRIPTS_REPLACE_CONFDIR="\$(echo "\$GEN_SCRIPTS_NEWFILE" | tr [a-z] [A-Z])_CONFIG_DIR"
GEN_SCRIPTS_REPLACE_CONFFILE="\$(echo "\$GEN_SCRIPTS_NEWFILE" | tr [a-z] [A-Z])_CONFIG_FILE"
GEN_SCRIPTS_REPLACE_OPTIONS_DIR="\$(echo "\$GEN_SCRIPTS_NEWFILE" | tr [a-z] [A-Z])_OPTIONS_DIR"
GEN_SCRIPTS_CONFIG_DIR="${GEN_SCRIPTS_CONFIG_DIR:-$GEN_SCRIPTS_CONFIG_DIR}"
GEN_SCRIPTS_BACKUP_DIR="${GEN_SCRIPTS_BACKUP_DIR:-$GEN_SCRIPTS_CONFIG_DIR/backups}"
# Make file options
# Default ask
OVERWRITE="${OVERWRITE:-A}"
# Skip editing file
EDITFILE="${EDITFILE:-N}"
# This should always be Y
MAKEFILE="${MAKEFILE:-Y}"

EOF
  [ -f "$GEN_SCRIPTS_CONFIG_DIR/settings.conf" ] && printf_green "Settings have been saved" || printf_error "Failed to save the settings"
}
__copy_files() {
  printf_green "Copying the template files"
  printf_yellow "from: $CASJAYSDEVDIR/templates/scripts"
  printf_yellow "to: $GEN_SCRIPTS_CONFIG_DIR/files"
  __cp_rf "$CASJAYSDEVDIR/templates/scripts/." "$GEN_SCRIPTS_CONFIG_DIR/files/"
}

__copy_templates() {
  if [ -d "$GEN_SCRIPTS_CONFIG_DIR/files/.git" ]; then
    am_i_online && git -C "$GEN_SCRIPTS_CONFIG_DIR/files" pull -q &>/dev/null && true || false
  else
    if [ "$(__count_files $GEN_SCRIPTS_CONFIG_DIR/files "3")" -ne 0 ]; then
      if [ "$GEN_SCRIPTS_COPY_CONFIRM" != "no" ]; then
        printf_read_question 6 "Would you like overwrite current files" "1" "COPY" "-s"
        if printf_answer_yes "$COPY"; then
          __copy_files
        else
          printf_exit "User cancelled"
        fi
      else
        __copy_files
      fi
    fi
  fi
  [ $? -eq 0 ] && [ -d "$GEN_SCRIPTS_CONFIG_DIR/files" ] &&
    printf_green "Install has succeeded" || printf_red "Install of the files failed"
}

__import_readme() {
  type="${1:-system}"
  if [ "$type" = user ]; then
    cat <<EOF | tee
#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME_README="$GEN_SCRIPTS_REPLACE_APPNAME"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $GEN_SCRIPTS_VERSION
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null) --help
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $GEN_SCRIPTS_CREATED
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-$get_desc}
# @TODO          : ${todo:-$get_todo}
# @Other         : ${other:-$get_other}
# @Resource      : ${res:-$get_res}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
printf_help() {
  printf "%b" "\$(tput setaf "\${2:-4}" 2>/dev/null)" "\t\t\$1" "\$(tput sgr0 2>/dev/null)"
  printf '\n'
}
get_desc() {
  grep_head(){ grep -E ^'.*#?@'\${1:-*}'' "\$2" 2>/dev/null | grep '  :' | head -n\${12:-$3} | sed 's#..* : ##g'; }
  local PATH="\$HOME/.local/bin:/usr/local/bin:/usr/bin:/usr/sbin"
  local appname="\$(type -P "\${PROG:-\$APPNAME}" 2>/dev/null || command -v "\${PROG:-\$APPNAME}" 2>/dev/null)"
  local desc="$(grep_head "Description" "\$appname" "12" | head -n1 | grep '^')"
  [ -n "\$desc" ] && printf '%s' "\$desc" || return 1
}
printf_descr() {
  [ -n "\${PROG:-$APPNAME}" ] && [ -n "\$(get_desc)" ] && printf_color "    \$(get_desc)" 6 || printf_help "\$1" "\${2:-10}"
}
printf_head() { printf_help "1" "################## " "\$2" " ##################"; }
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# begin
printf '\n'
printf_descr "    GEN_SCRIPTS_REPLACE_DESC"
printf_head "5" "$GEN_SCRIPTS_REPLACE_APPNAME main options"
printf_help "4" "Usage: $GEN_SCRIPTS_REPLACE_APPNAME "
printf_help "4" ""
printf_help "4" "-v, --version           - show script version"
printf_help "4" "-h, --help              - Shows this message"
$PREV_README
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end help
printf '\n'
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#exit "\${exitCode:-1}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end

EOF
  else
    if [ -n "$PREV_README" ]; then
      cat <<EOF | tee
#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME_README="$GEN_SCRIPTS_REPLACE_APPNAME"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $GEN_SCRIPTS_VERSION
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null) --help
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $GEN_SCRIPTS_CREATED
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-$get_desc}
# @TODO          : ${todo:-$get_todo}
# @Other         : ${other:-$get_other}
# @Resource      : ${res:-$get_res}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
printf_color() { printf "%b" "\$(tput setaf "\$2" 2>/dev/null)" "\$1" "\$(tput sgr0 2>/dev/null)"; }
printf_head() { printf_help "\$1" "################## " "\$2" " ##################"; }
printf_help() {
  test -n "\$1" && test -z "\${1//[0-9]/}" && local color="\$1" && shift 1 || local color="4"
  local msg="\$*"
  shift
  printf_color "\t\t\$msg\n" "\$color"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Begin help
printf '\n'
printf_head "5" "${PREV_DESCR:-$GEN_SCRIPTS_REPLACE_APPNAME main options}"
$PREV_README
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end help
printf '\n'
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#exit "\${exitCode:-1}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end

EOF
    else
      cat <<EOF | tee
#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME_README="$GEN_SCRIPTS_REPLACE_APPNAME"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $GEN_SCRIPTS_VERSION
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null) --help
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $GEN_SCRIPTS_CREATED
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-$get_desc}
# @TODO          : ${todo:-$get_todo}
# @Other         : ${other:-$get_other}
# @Resource      : ${res:-$get_res}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
printf_color() { printf "%b" "\$(tput setaf "\$2" 2>/dev/null)" "\$1" "\$(tput sgr0 2>/dev/null)"; }
printf_head() { printf_help "\$1" "################## " "\$2" " ##################"; }
printf_help() {
  test -n "\$1" && test -z "\${1//[0-9]/}" && local color="\$1" && shift 1 || local color="4"
  local msg="\$*"
  shift
  printf_color "\t\t\$msg\n" "\$color"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Begin help
printf '\n'
printf_head "5" "$GEN_SCRIPTS_REPLACE_APPNAME main options"
printf_help "4" "Usage: $GEN_SCRIPTS_REPLACE_APPNAME "
printf_help "4" ""
printf_help "4" "-h, --help                  - Shows this message"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end help
printf '\n'
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#exit "\${exitCode:-1}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end

EOF
    fi
  fi
}

__makefile() {
  local temp="$1"
  local new="${newfile:-$2}"
  local newdir="$(__dirname "$new")"
  local newfile="$(basename "$2")"
  shift 2
  __mkd "$newdir"
  __vars "$new"
  __cp_rf "$temp" "$new" || return 1
  __get_prev "$new" || return 1
  __edit_header "$new" || return 1
  local newcmd="$(command -v "$newfile" || type -P "$newfile" || ls -A "$newfile")"
  chmod -f 755 "$new" || return 1
  if grep -q 'local cur prev words cword opts' "$new"; then
    if [ -f "$newcmd" ]; then
      local GEN_SCRIPTS_REPLACE_license="$(__get_header 'License' "$new")"
      local GEN_SCRIPTS_REPLACE_readme="$(__get_header 'ReadME' "$new")"
      local GEN_SCRIPTS_REPLACE_desc="$(__get_header 'Description ' "$new")"
      local GEN_SCRIPTS_REPLACE_todo="$(__get_header 'TODO ' "$new")"
      local GEN_SCRIPTS_REPLACE_other="$(__get_header 'Other ' "$new")"
      local GEN_SCRIPTS_REPLACE_resource="$(__get_header 'Resource ' "$new")"
      local license="$(__get_header 'License ' "$newcmd")"
      local readme="$(__get_header 'ReadME ' "$newcmd")"
      local desc="$(__get_header 'Description ' "$newcmd")"
      local todo="$(__get_header 'TODO ' "$newcmd")"
      local other="$(__get_header 'Other ' "$newcmd")"
      local resource="$(__get_header 'Resource' "$newcmd")"
    fi
    [ -n "$license" ] && [ -n "$GEN_SCRIPTS_REPLACE_license" ] && __sed "$GEN_SCRIPTS_REPLACE_license" "$license" "$new"
    [ -n "$readme" ] && [ -n "$GEN_SCRIPTS_REPLACE_readme" ] && __sed "$GEN_SCRIPTS_REPLACE_readme" "$readme" "$new"
    [ -n "$desc" ] && [ -n "$GEN_SCRIPTS_REPLACE_desc" ] && __sed "$GEN_SCRIPTS_REPLACE_desc" "$desc" "$new"
    [ -n "$todo" ] && [ -n "$GEN_SCRIPTS_REPLACE_todo" ] && __sed "$GEN_SCRIPTS_REPLACE_todo" "$todo" "$new"
    [ -n "$other" ] && [ -n "$GEN_SCRIPTS_REPLACE_other" ] && __sed "$GEN_SCRIPTS_REPLACE_other" "$other" "$new"
    [ -n "$resource" ] && [ -n "$GEN_SCRIPTS_REPLACE_resource" ] && __sed "$GEN_SCRIPTS_REPLACE_resource" "$resource" "$new"
    local compfile="_$(basename "$new")_completion"
    local destfolder="$(dirname "$new")"
    printf_cyan "Creating the completion file: $compfile"
    __mv_f "$new" "$destfolder/$compfile" &&
      new="$destfolder/$compfile" &&
      filename="$compfile" &&
      destfolder="$newdir" &&
      chmod 664 "$destfolder/$filename" && exitCode=0 || exitCode=1
  fi
  [ ${exitCode:-$?} -ne 0 ] && printf_red "Failed to create $new" || printf_green "Your file has been created"
  return ${exitCode:-$?}
}
__edit_header() {
  local GEN_SCRIPTS_NEWFILE="$1"
  local GEN_SCRIPTS_NEWFILE_FULL="$(__get_full_file "$1")"
  local GEN_SCRIPTS_NEWFILE_SHORT="$(basename "$1")"
  local GEN_SCRIPTS_FULLPATH="$(__fullfilename "$1")"
  local GEN_SCRIPTS_NEWFILEDIR="$(__dirname $GEN_SCRIPTS_NEWFILE_FULL)"
  local GEN_SCRIPTS_NEWFILEDIR="${GEN_FILENAME:-$GEN_SCRIPTS_NEWFILEDIR}"
  local GEN_SCRIPTS_REPLACE_CONFDIR="$(__gen_confdir "$GEN_SCRIPTS_NEWFILE_SHORT")_CONFIG_DIR"
  local GEN_SCRIPTS_REPLACE_CONFFILE="$(__gen_confdir "$GEN_SCRIPTS_NEWFILE_SHORT")_CONFIG_FILE"
  local GEN_SCRIPTS_REPLACE_OPTIONS_DIR="$(__gen_confdir "$GEN_SCRIPTS_NEWFILE_SHORT")_OPTIONS_DIR"
  __vars "$*"
  [ -f "$GEN_SCRIPTS_NEWFILE" ] && printf_green "Editing the header info" || printf_exit 1 1 "Failed to created the file"
  __sed "GEN_SCRIPTS_REPLACE_APPNAME" "${GEN_SCRIPTS_NEWFILEDIR##*/}" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_OPTIONS_DIR" "$GEN_SCRIPTS_REPLACE_OPTIONS_DIR" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_CONFDIR" "$GEN_SCRIPTS_REPLACE_CONFDIR" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_CONFFILE" "$GEN_SCRIPTS_REPLACE_CONFFILE" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_COPYRIGHT" "$GEN_SCRIPTS_COPYRIGHT" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_VERSION" "$GEN_SCRIPTS_VERSION" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_FILENAME" "$(__filename "$GEN_SCRIPTS_NEWFILE")" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_FULLFILENAME" "$GEN_SCRIPTS_FULLPATH" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_VERSION" "$GEN_SCRIPTS_VERSION" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_DATE" "$GEN_SCRIPTS_CREATED" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_LICENSE" "$GEN_SCRIPTS_DEFLICENSE" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_README" "$GEN_SCRIPTS_DEFREADME" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_AUTHOR" "$GEN_SCRIPTS_AUTHOR" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_EMAIL" "$GEN_SCRIPTS_EMAIL" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_YEAR" "$GEN_SCRIPTS_YEAR" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_DESC" "${desc:-$get_desc}" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_TODO" "${todo:-$get_todo}" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_OTHER" "${other:-$get_other}" "$GEN_SCRIPTS_NEWFILE"
  __sed "GEN_SCRIPTS_REPLACE_RES" "${res:-$get_res}" "$GEN_SCRIPTS_NEWFILE"
  return $?
}

__gen_header_help() {
  printf_head "Usage: gen-script -head filename options"
  printf_blue "-h, --help                  -  Show this message"
  printf_blue "-a, --all                   -  Show options"
  printf_blue "-f, --functions             -  Shows functions"
  printf_blue "-d, --description           -  Creates the description for file header"
  printf_blue "-t, --todo                  -  Add a TODO to file header"
  printf_blue "-c, --copy                  -  Adds a copyrigth to file header"
  printf_blue "-o, --other                 -  Adds an other to the file header"
  printf_blue "-r, --res                   -  Adds resources to the file header"
  printf_blue "-i, --type                  -  Adds type to functions: user system"
  printf_blue "-p, --prev                  -  Will set header based on an existing file"
  printf_blue "-u, --user                  -  Generate a script for suitable for local user"
  printf_blue "-l, --license               -  Adds the license type to header"
  printf_blue "-e, --no                    -  Don't ask to edit file"
  printf_blue "-k, --keep                  -  Will not overwrite an existing file"
  printf_blue "--replace                   -  Imports and creates a new header to replace an older one"
  printf_blue "--raw                       -  Generate a raw header"
  printf_newline
  printf_blue "types: devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr"
  exit 0
}
__gen_header() {
  [ -z "$pause" ] || { clear && printf_newline "\n\n\n"; }
  rerun() {
    unset gen_header_replace exitCode
    rerun=true
    __gen_header
    exit $?
  }
  if [ "$rerun" != "true" ]; then
    __set_header "$@"
    __vars "$filename"
    printf_green "New header info for $filename "
    __get_prev "$filename"
    [ -n "$gen_header_raw" ] && filename=template
    local GEN_SCRIPTS_DEFREADME="$(__filename $filename 2>/dev/null) --help"
    local GEN_SCRIPTS_NEWFILE="$filename"
    [ -n "$gen_header_raw" ] || [ -n "${desc:-$get_desc}" ] || printf_yellow "Description: ${desc:-None provided}"
    [ -n "$gen_header_raw" ] || [ -n "${todo:-$get_todo}" ] || printf_yellow "TODO: ${todo:-None provided}"
  fi
  if [ -n "$gen_header_prev" ]; then
    __check_header "$filename" || __no_header
    __providefilename "$filename"
    printf_blue "Imported header from $(__fullfilename "$filename")"
    printf_newline
    __prev_header
  elif [ "$gen_header_replace" = true ]; then
    __check_header "$filename" || __no_header
    __providefilename "$filename"
    printf_blue "Imported header from $(__fullfilename "$filename")"
    printf_newline
    __replace_header "$filename"
  elif [ -n "$gen_header_raw" ]; then
    printf_blue "Showing the raw header template"
    printf_newline
    __gen_header_raw || rerun
  elif [ -f "$GEN_SCRIPTS_CONFIG_DIR/templates/headerfile" ] && [ -z "$gen_header_user" ]; then
    printf_blue "Using header from $GEN_SCRIPTS_CONFIG_DIR/templates/headerfile"
    printf_newline
    cat <<EOF | tee
$(. $GEN_SCRIPTS_CONFIG_DIR/templates/headerfile)
EOF
  elif [ -n "$gen_header_user" ] && [ -z "$gen_header_raw" ]; then
    printf_newline
    __gen_template_user
  else
    printf_newline
    __gen_template_system
  fi
  if [ "$showFunctions" = true ]; then
    __gen_functions
    printf_newline
  else printf_newline; fi
  [ ${exitCode:-$?} -ne 0 ] || printf_blue "Your header is ready for use"
  [ -z "$pause" ] || __print_wait "Press any key when done"
  printf_newline
  return ${exitCode:-$?}
}

__gen_template_user() {
  if [ -f "$GEN_SCRIPTS_CONFIG_DIR/templates/gen_user.sh" ]; then
    cat <<EOF | tee
$(. $GEN_SCRIPTS_CONFIG_DIR/templates/gen_user.sh)
EOF
  else
    cat <<EOF | tee
#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
PROG="\$(basename "\$0")"
VERSION="$GEN_SCRIPTS_VERSION"
USER="\${SUDO_USER:-\${USER}}"
HOME="\${USER_HOME:-\${HOME}}"
SRC_DIR="\${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $GEN_SCRIPTS_VERSION
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null) --help
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $GEN_SCRIPTS_CREATED
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-$get_desc}
# @TODO          : ${todo:-$get_todo}
# @Other         : ${other:-$get_other}
# @Resource      : ${res:-$get_res}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
EOF
  fi
}
__gen_template_system() {
  if [ -f "$GEN_SCRIPTS_CONFIG_DIR/templates/gen_system.sh" ]; then
    cat <<EOF | tee
$(. $GEN_SCRIPTS_CONFIG_DIR/templates/gen_system.sh)
EOF
  else
    cat <<EOF | tee
#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="\$(basename "\$0")"
VERSION="$GEN_SCRIPTS_VERSION"
USER="\${SUDO_USER:-\${USER}}"
HOME="\${USER_HOME:-\${HOME}}"
SRC_DIR="\${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : $GEN_SCRIPTS_VERSION
# @Author        : $GEN_SCRIPTS_AUTHOR
# @Contact       : $GEN_SCRIPTS_EMAIL
# @License       : $GEN_SCRIPTS_DEFLICENSE
# @ReadME        : $GEN_SCRIPTS_DEFREADME
# @Copyright     : $GEN_SCRIPTS_COPYRIGHT
# @Created       : $GEN_SCRIPTS_CREATED
# @File          : $(__filename $GEN_SCRIPTS_NEWFILE 2>/dev/null)
# @Description   : ${desc:-$get_desc}
# @TODO          : ${todo:-$get_todo}
# @Other         : ${other:-$get_other}
# @Resource      : ${res:-$get_res}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
EOF
  fi
}
__gen_header_raw() {
  if [ -f "$GEN_SCRIPTS_CONFIG_DIR/templates/gen_raw.sh" ]; then
    cat <<EOF | tee
$(. $GEN_SCRIPTS_CONFIG_DIR/templates/gen_raw.sh)
EOF
  else
    cat <<EOF | tee
#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
PROG="\$(basename "\$0")"
VERSION="GEN_SCRIPTS_REPLACE_VERSION"
USER="\${SUDO_USER:-\${USER}}"
HOME="\${USER_HOME:-\${HOME}}"
SRC_DIR="\${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#set opts

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : GEN_SCRIPTS_REPLACE_VERSION
# @Author        : GEN_SCRIPTS_REPLACE_AUTHOR
# @Contact       : GEN_SCRIPTS_REPLACE_EMAIL
# @License       : GEN_SCRIPTS_REPLACE_LICENSE
# @ReadME        : GEN_SCRIPTS_REPLACE_FILENAME --help
# @Copyright     : GEN_SCRIPTS_REPLACE_COPYRIGHT
# @Created       : GEN_SCRIPTS_REPLACE_DATE
# @File          : GEN_SCRIPTS_REPLACE_FILENAME
# @Description   : GEN_SCRIPTS_REPLACE_DESC
# @TODO          : GEN_SCRIPTS_REPLACE_TODO
# @Other         : GEN_SCRIPTS_REPLACE_OTHER
# @Resource      : GEN_SCRIPTS_REPLACE_RES
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -'
EOF
  fi
}

__gen_functions() {
  __vars "$@"
  if [ -n "$gen_header_user" ]; then
    if [ -f "$GEN_SCRIPTS_CONFIG_DIR/templates/gen_user_functions.sh" ]; then
      cat <<EOF | tee
$(. $GEN_SCRIPTS_CONFIG_DIR/templates/gen_user_functions.sh)
EOF
    else
      cat <<EOF | tee
# Main function file
if [ -f "\$SRC_DIR/functions.bash" ]; then
  FUNCTIONS_DIR="\$SRC_DIR"
  . "\$FUNCTIONS_DIR/functions.bash"
elif [ -f "\$HOME/.local/bin/functions.bash" ]; then
  FUNCTIONS_DIR="\$HOME/.local/bin"
  . "\$FUNCTIONS_DIR/functions.bash"
else
  printf "\t\t\033[0;31m%s \033[0m\n" "Could not source the functions file from $\FUNCTIONS_DIR"
  return 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
EOF
    fi
  else
    if [ -f "$GEN_SCRIPTS_CONFIG_DIR/templates/gen_system_functions.sh" ]; then
      cat <<EOF | tee
$(. $GEN_SCRIPTS_CONFIG_DIR/templates/gen_system_functions.sh)
EOF
    else
      echo '# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
'${type:-user}_install'
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
'
    fi
  fi
}
__backup_file() {
  local BASEDIR="${GEN_SCRIPTS_BACKUP_DIR:-$GEN_SCRIPTS_CONFIG_DIR/backups}"
  local BACKUPDIR="$BASEDIR/${destfolder/\//}"
  local NAME="$filename-$(date +'%m%d%Y%H%M' 2>/dev/null)"
  [ -d "$BACKUPDIR" ] || __mkd "$BACKUPDIR"
  if mv -f "$destfolder/$filename" "$BACKUPDIR/$NAME" &>/dev/null; then
    printf_blue "copied $filename to ${BACKUPDIR/$GEN_SCRIPTS_CONFIG_DIR\//}/$NAME"
  else
    printf_red "Failed to copy $filename BACKUPDIR/$NAME"
  fi
  if [ -f "$destfolder/$filename" ]; then __rm_rf "$destfolder/$filename"; fi
}
__vars() {
  [ -f "$topdir/README.md" ] && GEN_SCRIPTS_DEFREADME="README.md" || GEN_SCRIPTS_DEFREADME="$(basename "$1" 2>/dev/null) --help"
  [ -f "$topdir/LICENSE.md" ] && GEN_SCRIPTS_DEFLICENSE="LICENSE.md" || GEN_SCRIPTS_DEFLICENSE="$GEN_SCRIPTS_DEFLICENSE"
  [ -f "$topdir/version.txt" ] && GEN_SCRIPTS_VERSION="$(cat $topdir/version.txt 2>/dev/null)" || GEN_SCRIPTS_VERSION="$GEN_SCRIPTS_VERSION"
}

__find_file() {
  arg1=${1// /\/}
  arg2=${2// /\/}
  arg3=${3// /\/}
  if [ -f "$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/$arg2/${arg3:-default}" ]; then
    template="$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/$arg2/${arg3:-default}"
    [[ "$4" = -* ]] && dest="${newScript:-$filename}" || dest="${4:-$filename}"
    shift 3
  elif [ -f "$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/${arg2:-default}" ]; then
    template="$GEN_SCRIPTS_TEMPLATE_DIR/$arg1/${arg2:-default}"
    [[ "$3" = -* ]] && dest="${newScript:-$filename}" || dest="${3:-$filename}"
    shift 2
  elif [ -f "$GEN_SCRIPTS_TEMPLATE_DIR/${arg1:-default}" ]; then
    template="$GEN_SCRIPTS_TEMPLATE_DIR/${arg1:-default}"
    [[ "$2" = -* ]] && dest="${newScript:-$filename}" || dest="${2:-filename}"
    shift 1
  else
    printf_green "Using the default template: bash"
    template="$GEN_SCRIPTS_TEMPLATE_DIR/shell/bash"
    [[ "$1" = -* ]] && dest="${newScript:-$filename}" || dest="${1:-$filename}"
  fi
  dest="${dest:-newScript}"
  __set_header "$dest" "$@"
}
__default_name() {
  [ -z "${1}" ] && printf_red "No filename was provided: using default $(__filename "${2}")" && OVERWRITE=N || return 0
}
__gen_opts() {
  local OPTS="$*"
  shift $#
  [ -d "$GEN_SCRIPTS_OPTSDIR" ] && gen_opts_seen=yes || __mkd "$GEN_SCRIPTS_OPTSDIR"
  if [ -z "$gen_opts_seen" ]; then
    printf_green "Generating to options file for bash completion"
  fi
  [ -n "$OPTS" ] && __GEN_OPTS=true
  if [[ "$OPTS" = "" ]] && [[ -z "$__GEN_OPTS" ]]; then
    __header_opts -a --long
    echo "-config -replace -function -header -installers -os -shell -all -copy"
    printf_newline
  fi
  if [[ "$OPTS" = --help ]]; then
    printf_blue "-create        -  create all opts files"
    printf_blue "-header        -  create header opts files"
    printf_blue "-long          -  create gen-script opt file"
    return
  fi
  if [[ "$OPTS" = -create ]]; then
    __rm_rf "$GEN_SCRIPTS_OPTSDIR"
    __mkd "$GEN_SCRIPTS_OPTSDIR"
    __gen_opts "-header"
    __gen_opts "-short"
    __gen_opts "-long"
  fi
  if [[ "$OPTS" = -header ]]; then
    __header_opts "-a" "--long" >"$GEN_SCRIPTS_OPTSDIR/opts-header.txt"
  fi
  if [[ "$OPTS" = -short ]]; then
    echo "-c -g -f -h -i -o -s -i" >"$GEN_SCRIPTS_OPTSDIR/opts-short.txt"
    __header_opts "-a" "--short" >>"$GEN_SCRIPTS_OPTSDIR/opts-short.txt"
  fi
  if [[ "$OPTS" = -long ]]; then
    echo "-replace -readme -options -config -function -header -installers -os -shell -copy all" >"$GEN_SCRIPTS_OPTSDIR/opts.txt"
  fi
  gen_opts_seen=true
  return
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ "$(__count_files $GEN_SCRIPTS_CONFIG_DIR/files "3")" -eq 0 ]; then
  __mkd "$GEN_SCRIPTS_CONFIG_DIR/files"
  if [ "$(__count_files "$CASJAYSDEVDIR/templates/scripts" "2")" -ne 0 ]; then
    printf_green "Setting up the Scripts directory"
    __cp_rf "$CASJAYSDEVDIR/templates/scripts/." "$GEN_SCRIPTS_CONFIG_DIR/files/"
  else
    printf_exit "1" "1" "No scripts exist"
  fi
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[ -f "$GEN_SCRIPTS_CONFIG_DIR" ] && __rm_rf "$GEN_SCRIPTS_CONFIG_DIR"
[ -d "$GEN_SCRIPTS_CONFIG_DIR" ] || __mkd "$GEN_SCRIPTS_CONFIG_DIR"
[ -f "$GEN_SCRIPTS_OPTSDIR/opt-header.txt" ] || __gen_opts "-header"
[ -f "$GEN_SCRIPTS_OPTSDIR/optshort-header.txt" ] || __gen_opts "-short"
[ -f "$GEN_SCRIPTS_OPTSDIR/optlong-long.txt" ] || __gen_opts "-long"
[ -f "$GEN_SCRIPTS_CONFIG_DIR/settings.conf" ] || [ "$1" = -config ] || __gen_config
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main application
case $1 in
-replace)
  shift 1
  [ -f "$1" ] && filename="$1" || filename="$(type -P "$(basename "$1")")"
  if [ $# -ne 3 ]; then
    printf_exit "Requires filename search replace"
  else
    __update_header "$filename" "$2" "$3"
  fi
  exit
  ;;
-a | *options)
  shift 1
  __gen_opts "$@"
  exit
  ;;
-c | *copy)
  shift 1
  __copy_templates "$@"
  exit $?
  ;;
-g | *config)
  shift 1
  __gen_config && __copy_templates "$@"
  exit $?
  ;;

-f | *function)
  shift 1
  [[ $1 = -u ]] && gen_header_user=true && shift 1
  [ $# -lt 2 ] || printf_exit "Only takes a filename as an argument"
  printf_green "New functions info for ${1:-template}"
  __gen_functions ${1:-template}
  printf_green "End of functions"
  exit $?
  ;;

-readme)
  shift 1
  if [ $# -lt 3 ]; then printf_exit 1 1 "Usage: gen-script -readme template filename importfile type[system,user]"; fi
  printf_green "Creating the readme file"
  readme_template="$GEN_SCRIPTS_CONFIG_DIR/files/other/${1:=script_help}"
  prev_filename="${3:-$2}"
  new_filename="${2:-$PWD/man/$(basename "$prev_filename")}"
  new_type="${4:-system}"
  GEN_SCRIPTS_NEWFILE="$prev_filename"
  PREV_README="$(cat <<<"$(__prev_readme "$(__fullfilename "$prev_filename")")")"
  GEN_SCRIPTS_REPLACE_APPNAME="$(__filename "$prev_filename")"
  __get_prev "$(basename "$prev_filename")"
  desc="$(basename "$prev_filename") manual"
  printf_yellow "Using the $new_type template and copying"
  printf_green "from: $readme_template"
  printf_green "to: $new_filename "
  [ -f "$new_filename" ] && __cp_rf "$new_filename" "$GEN_SCRIPTS_CONFIG_DIR/backups/$new_filename"
  if [ -f "$readme_template" ] && [ -f "$prev_filename" ]; then
    __mkd "$(dirname "$new_filename")"
    __cp_rf "$readme_template" "$new_filename"
    printf_blue "Importing from $prev_filename"
    __import_readme "${new_type:-system}" "$(__prev_readme "$prev_filename")" >"$new_filename"
    [ -f "$new_filename" ] && __sed "GEN_SCRIPTS_REPLACE_APPNAME" "$(basename "$new_filename")" "$new_filename"
  elif [ -n "$new_filename" ]; then
    __mkd "$(dirname "$new_filename")"
    __cp_rf "$readme_template" "$new_filename"
    __import_readme "${new_type:-system}" "$(__prev_readme "$prev_filename")" >"$new_filename"
  else
    printf_exit "$readme_template doesn't exist"
  fi
  if [ -f "$new_filename" ]; then
    chmod 755 "$new_filename"
    printf_exit 2 0 "Successfully created the new readme file"
  else
    printf_exit 1 1 "Creation of the readme file has failed"
  fi
  ;;

-head | *header)
  shift 1
  __header_opts "$@"
  if [[ "$1" != -* ]] && [ $# -ne 0 ]; then
    filename="${1:-template}"
    shift 1
  elif __remove_opts "$HEADER_ARGS" &>/dev/null; then
    filename="$(__remove_opts "$HEADER_ARGS")"
    shift 1
  else
    filename="template"
  fi
  __gen_header "$@"
  exit $?
  ;;

-i | *installers)
  filename="${3:-$2}"
  __default_name "$3" "${filename}"
  __find_file "$@"
  ;;

-o | *os)
  filename="${3:-$2}"
  __default_name "$3" "${filename}"
  __find_file "$@"
  ;;

-s | *shell)
  filename="${3:-$2}"
  __default_name "$3" "${filename}"
  __find_file "$@"
  ;;

-l | *all) ## Bash Completion list
  shift 1
  filename="${2:-$1}"
  __default_name "$2" "${filename}"
  __find_file "$@"
  ;;

*) ## Allows drop in without need to update this
  __find_file "$@"
  ;;
esac
shift $#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sanity check
[ -f "$template" ] || printf_exit 1 1 "The template file doesn't exist: $template"
[ -n "${dest:-newScript}" ] || printf_exit 1 1 "Something went wrong while setting up filename"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# file and folder setup
filename="$(__filename ${dest:-newScript} 2>/dev/null)"
destfolder="$(__basedir $dest 2>/dev/null)"
templatename="$(basename $template)"
# # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Generate the file
if [ "$templatename" = "readme" ] || [ "$templatename" = "script_help" ]; then
  printf_yellow "Setting up the script as a scripts readme file"
  destfolder="${GEN_SCRIPTS_MAN_DIR:-$destfolder/man}"
  filename="${filename}"
fi
if [ "$filename" = "newScript" ]; then
  printf_read_question "3" "What should we name this ?" "120" "tmpfilename" "-i ${dest:-$filename}"
  tmpfilename="${tmpfilename:-$filename}"
else
  tmpfilename="$filename"
fi
filename=${tmpfilename// /_}
if [ -f "$destfolder/$filename" ] && [ "$OVERWRITE" != "Y" ]; then
  printf_read_question "3" "Should we overwrite this file?" "1" "YN" "-s"
  if printf_answer_yes "$YN"; then
    printf_read_question "3" "Should i display file before overwrite?" "1" "SHOW" "-s"
    printf_answer_yes "$SHOW" && cat "$destfolder/$filename" || __backup_file
  else
    printf_exit 1 1 "Refusing to overwrite existing file!"
  fi
fi
if [ "$MAKEFILE" != "N" ]; then
  printf_green "Copying the file ${template//$GEN_SCRIPTS_TEMPLATE_DIR\//} to"
  printf_yellow "$destfolder/$filename"
  __makefile "${template:?}" "$destfolder/$filename"
elif printf_read_question "3" "Should we just display this file?" "1" "YN" "-s" && printf_answer_yes "$YN"; then
  __makefile "${template:?}" "${TMPDIR:-/tmp}/template.$$.sh"
  cat "${TMPDIR:-/tmp}/template.$$.sh"
  __rm_rf "${TMPDIR:-/tmp}/template.$$.sh"
else
  printf_red "Not creating the file due to the MAKEFILE=no being set"
fi
if [ "$EDITFILE" != "N" ]; then
  [ -n "$OPENEDIT" ] || printf_read_question "3" "Should we edit this file?" "1" "EDIT" "-s"
  printf_answer_yes "$EDIT" && $EDITOR "$destfolder/$filename"
fi
printf_newline ""
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit ${exitCode:-$?}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end
