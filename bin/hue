#!/usr/bin/env bash

APPNAME="$(basename $0)"
SCRIPTDIR="$(dirname "${BASH_SOURCE[0]}")"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : hue
# @Created     : Mon, Dec 31, 2019, 00:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : home automation - philips hue script
# @Help        : http://hkionline.net/posts/using-phillips-hue-from-the-command-line
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
user_installdirs "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
main() {
  # variables
  unset hue_api_key hue_device hue_option
  local setopts="$1"
  local state="/tmp/automate_hue"
  local hue_device="$(__hostname2ip ${HUE_HUB_DEVICE:-$2})"
  local hue_api_key="${HUE_ACCESS_TOKEN}"
  local hue_group="${HUE_GROUP:-0}"
  local api_url="${HUE_HUB_API:-http://$hue_device/api/$hue_api_key/groups/$hue_group}"
  touch "$state"

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  [ ! -z "$hue_api_key" ] || printf_exit "Please set your hue api key"
  [ ! -z "$hue_device" ] || printf_exit "Please enter the hostname of your hue hub"
  [ ! -z "$hue_device" ] || printf_exit "Please enter the the command you want to send to your hue"

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # functions
  getstate() { cat "$state"; }
  hue_on() {
    printf_green "Telling $hue_device to turn on the lights"
    curl -LSsq -X PUT "$api_url/action" -d '{"on": true}' &>/dev/null && echo on >$state
  }
  hue_off() {
    printf_green "Telling $hue_device to turn off the lights"
    curl -LSsq -X PUT "$api_url/action" -d '{"on": false}' &>/dev/null && echo off >$state
  }
  hue_toggle() {
    if [ "$(cat $state)" = on ]; then
      hue_off
    elif [ "$(cat $state)" = off ]; then
      hue_on
    fi
  }

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # main
  if [ ! -s "$state" ]; then echo on >$state; fi

  case "$setopts" in
  on | true | 0 | stop)
    hue_on
    ;;

  off | false | 1 | play)
    hue_off
    ;;

  toggle)
    hue_toggle
    ;;

  state)
    case "$2" in
    text) echo -e "$(getstate)" ;;
    json | *) echo -e '{"status":"'$(getstate)'"}' ;;
    esac
    ;;

  info)
    printf_green "Getting info for group $hue_group from $hue_device"
    curl -LSs "$api_url" | jq
    ;;
  *)
    hue_toggle
    ;;
  esac

}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#execute
main "$@"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# end
