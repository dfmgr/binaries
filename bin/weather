#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : weather
# @Created     : Wed, Aug 05, 2020, 02:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : weather in your console
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Set functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
user_installdirs "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

LOCID="${MYLOCATIONID:-$2}"
API="http://wttr.in"
API2="http://v2.wttr.in"
APIACCU="http://api.wunderground.com/auto/wui/geo/ForecastXML/index.xml"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

report() { printf_color "Weather report for $LOCID\n" "21"; }
grep_v() { grep -v "Weather report" | grep -v "Location"; }
wttrin() { __curl "$API/$LOCID?AFu$2" | grep_v && report; }
wttrin2() { __curl -LSs "$API2/$LOCID?AFu$2" | grep_v && report; }
wttrimage() { __curl -LSsq "$API/$LOCID?AFuw.png" -o "$HOME/.local/tmp/weather.png"; }
wttrcity() { __curl -LSsq "$API/$MYLOCATIONZIP?AFu$2" | grep -v "Weather report" | head -n 6 && echo ""; }
wttrmoon() { __curl -LSs "$API/moon?AFu$2"; }
wttrsimple() { __curl -LSs "$API/$LOCID?format=3"; }
wttraccuweather() { __curl -s "$APIACCU?query=${*:-$MYLOCATIONID}" | perl -ne '/<title>([^<]+)/&&printf "%s: ",$1;/<fcttext>([^<]+)/&&print $1,"\n"'; }

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__mkd "$HOME/.local/tmp"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__api_test

case "$1" in
help | -h | --help)
  __help
  ;;
city | -c | --city)
  shift 1
  LOCID="${MYLOCATIONZIP:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && printf_help "Usage: $APPNAME city zipcode"
  wttrcity "$@"
  ;;
v2 | -v2 | --v2)
  shift 1
  LOCID="${MYLOCATIONID:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && printf_help "Usage: $APPNAME v2 zipcode"
  wttrin2 "$@"
  ;;
img | -i | --img | image | --image)
  shift 1
  LOCID="${MYLOCATIONID:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && printf_help "Usage: $APPNAME img zipcode"
  wttrimage "$@"
  ;;
moon | -m | --moon)
  shift 1
  LOCID="${MYLOCATIONZIP:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && printf_help "Usage: $APPNAME moon"
  wttrmoon "$@"
  ;;
simple | -simple | --simple)
  shift 1
  LOCID="${MYLOCATIONID:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && printf_help "Usage: $APPNAME simple"
  wttrsimple "$@"
  ;;
accu | accuweather)
  shift 1
  LOCID="${MYLOCATIONID:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && printf_help "Usage: $APPNAME accuweather"
  wttraccuweather "$@"
  ;;
*)
  shift 0
  LOCID="${MYLOCATIONID:-$1}"
  [ -z "$LOCID" ] && __help
  [ "$1" = "--help" ] && __help
  wttrin "$@"
  ;;

esac

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# end
