#!/usr/bin/env bash

APPNAME="update-motd"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
PATH="/usr/games:$PATH"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : jason@casjaysdev.com
# @File        : update-motd
# @Created     : Mon, Dec 31, 2019, 00:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : Update the MOTD and ISSUE files
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Set functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
else
  mkdir -p "/tmp/CasjaysDev/functions"
  curl -LSs "$SCRIPTSFUNCTURL/$SCRIPTSFUNCTFILE" -o "/tmp/CasjaysDev/functions/$SCRIPTSFUNCTFILE" || exit 1
  . "/tmp/CasjaysDev/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

[ "$1" = "--force" ] && shift 1 && __requiresudo rm -Rf "/etc/casjaysdev/messages/issue/legal.txt"

__requiresudo rm -Rf /etc/issue* /etc/motd*

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# sed MacOS and Linux fix
sed="$(command -v gsed 2>/dev/null || command -v sed 2>/dev/null)"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__requiresudo true
__getlipaddr

HOSTNAME="$(hostname -f 2>/dev/null)"
HOSTSHORT="$(hostname -s 2>/dev/null)"
CURRIP4=${CURRIP4}
CURRIP6=${CURRIP6}

dategit="$(date +"%m%d%Y%H%M-git")"
datever="$(date +"%b %d, %Y at %H:%M")"
if [ -f /etc/casjaysdev/updates/versions/scripts.txt ]; then
  scriptsversion="$(__devnull2 cat /etc/casjaysdev/updates/versions/scripts.txt)"
else scriptsversion="$dategit"; fi
if [ -f /etc/casjaysdev/updates/versions/configs.txt ]; then
  configsversion="$(__devnull2 cat /etc/casjaysdev/updates/versions/configs.txt)"
else configsversion="$dategit"; fi
if [ -f /etc/casjaysdev/updates/versions/date.scripts.txt ]; then
  scriptsdate="$(__devnull2 cat /etc/casjaysdev/updates/versions/date.scripts.txt)"
else scriptsdate="$datever"; fi
if [ -f /etc/casjaysdev/updates/versions/date.configs.txt ]; then
  configsdate="$(__devnull2 cat /etc/casjaysdev/updates/versions/date.configs.txt)"
else configsdate="$datever"; fi
distro_version="$distro_version"

messages_issue() {
  if [ -f "$SCRIPTSFUNCTDIR/templates/casjaysdev-legal.txt" ] && [ ! -f /etc/casjaysdev/messages/issue/legal.txt ]; then
    __cp_rf "$SCRIPTSFUNCTDIR/templates/casjaysdev-legal.txt" "/etc/casjaysdev/messages/issue/legal.txt"
  fi
  local messages=$(__devnull2 ls /etc/casjaysdev/messages/issue/*.txt | wc -l)
  if [ "$messages" != "0" ]; then
    __requiresudo $sed -i 's#MYFULLHOSTNAME#'$HOSTNAME'#g' "/etc/casjaysdev/messages/issue/legal.txt"
    __requiresudo $sed -i 's#MYHOSTNAME#'$HOSTSHORT'#g' "/etc/casjaysdev/messages/issue/legal.txt"
    __requiresudo $sed -i 's#MYHOSTIP#'$CURRIP4'#g' "/etc/casjaysdev/messages/issue/legal.txt"
    __requiresudo $sed -i 's/MYHOSTIP6/'$CURRIP6'/g' "/etc/casjaysdev/messages/issue/legal.txt"
    __requiresudo find "/etc/casjaysdev/messages" -type f -exec "$sed" -i 's#Welcome to.*#Welcome to '$HOSTNAME'!#g' {} \; >/dev/null 2>&1
    __requiresudo find "/etc/casjaysdev/messages" -type f -exec "$sed" -i 's#MY Hostname is.*#MY Hostname is:      '$HOSTSHORT'#g' {} \; >/dev/null 2>&1
    __requiresudo find "/etc/casjaysdev/messages" -type f -exec "$sed" -i 's#MY IP Address is.*#MY IP Address is:    '$CURRIP4'#g' {} \; >/dev/null 2>&1
    __requiresudo find "/etc/casjaysdev/messages" -type f -exec "$sed" -i 's#MY IP6 Address is.*#MY IP6 Address is:   '$CURRIP6'#g' {} \; >/dev/null 2>&1

    cat /etc/casjaysdev/messages/issue/* 2>/dev/null | "$sed" '/^$/d' | "$sed" '1i\ ' | __requiresudo tee -a /etc/issue >/dev/null 2>&1
    printf "\n" | __requiresudo tee -a /etc/issue >/dev/null 2>&1
  fi
}

messages_motd() {
  local messages=$(__devnull2 ls /etc/casjaysdev/messages/motd/*.txt | wc -l)
  if [ "$messages" != "0" ]; then
    cat /etc/casjaysdev/messages/motd/* | "$sed" '/^$/d' | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  fi
}

motd_fortune() {
  if [ "$(__devnull2 command -v fortune)" ] && [ -n "$(__devnull2 command -v cowsay)" ]; then
    printf "\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
    fortune | cowsay | __requiresudo tee -a /etc/motd >/dev/null 2>&1
    printf "\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  else
    printf "\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  fi
}

conf_versions() {
  if __if_os_id debian; then
    printf "Debian version: $distro_version\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
    printf "Config version: $configsversion\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  fi

  if __if_os_id rhel; then
    printf "RHEL version: $distro_version\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
    printf "Config version: $configsversion\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  fi

  if __if_os_id arch; then
    printf "Arch version: $distro_version\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
    printf "Config version: $configsversion\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  fi
  if __if_os_id mac; then
    printf "Mac version: $distro_version\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
    printf "Config version: $configsversion\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  fi
  printf "Scripts version $scriptsversion\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  printf "configs were last updated on: $configsdate\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  printf "scripts package was last updated on: $scriptsdate\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
  printf "Messages were last updated on: $(date +"%b %d, %Y at %H:%M")\n\n" | __requiresudo tee -a /etc/motd >/dev/null 2>&1
}

finalize() {
  __requiresudo touch /etc/issue /etc/motd
  cat /etc/motd | __requiresudo tee -a /etc/motd.net >/dev/null 2>&1
  cat /etc/issue | __requiresudo tee -a /etc/issue.net >/dev/null 2>&1
  if [ "$1" = "--console" ]; then
    shift 1
    cat /etc/issue /etc/motd
  fi
  if [ "$1" = "--debug" ]; then
    shift 1
    cat /etc/issue /etc/motd
    printf_green "scriptsversion: $scriptsversion"
    printf_green "configsversion: $configsversion"
    printf_green "scriptsdate:    $scriptsdate"
    printf_green "configsdate:    $configsdate"
    printf_green "hostname:       $HOSTSHORT"
    printf_green "full hostname:  $HOSTNAME"
    printf_green "current ip:     $CURRIP4"
    printf_green "current ip6:    $CURRIP6"

  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# main function
main() {
  motd_fortune
  messages_motd
  messages_issue
  conf_versions
  finalize "$@"
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# run app
main "$@"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

exit $?
# end
